---
title: "Class and mortality in NHIS"
author: "Jerzy Eisenberg-Guyot"
date: "`r format(Sys.time(), '%B %Y')`"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
    keep_md: true
always_allow_html: true
---

# EMAIL NHIS ASKING WHEN LINKAGE THROUGH 2018 COMING OUT

# do mice in one step, analysis in other
# why does mortwt have a little missingness? 
# need to handle hispanic oversample correctly: advice here: https://nhis.ipums.org/nhis/userNotes_Hispanic_oversample.shtml
# incorporate firmno variable?
# subdivide workers (and managers?) based on ONET or Krieger's method

# investigate how to estimate change in inequities over time - problematic in survival settings? might want to compute absolute risks in case HR increasing because RD decreasing with less f/u - or could restrict f/u to shorter time period
# examine cause-specific mortality - need to worry about competing events. detailed cause of death not available from 2005-on

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r warning=FALSE, message=FALSE}
library(dplyr)
library(data.table)
library(here)
library(survival)
library(rms)
library(broom)
library(Rcpp)
library(rstpm2)
library(survey)
library(kableExtra)
library(tableone)

#load dat
dat <- fread(here('nhis_1986_2014.csv'))

#make all variable names lowercase
dat %>%
  rename_all(tolower) -> dat
  
#remove those ineligible for mortality follow-up and those <25 or 65+ and those who aren't sample adults from 1997-on (occ1995 and classwk not available for others after that time)
#also exclude 1997-2000, when there's no data on whether business is incorporated or not
#exclude those with missing mortwt (0.04% after making other exclusions)
dat %>% 
  filter(mortelig==1 & (is.na(astatflg) | astatflg==1) & (year<1997 | year>2000) & !is.na(mortwt)) -> dat

#make variables
dat %>%
  mutate_at(.vars=(vars(-c(mortucod, mortwt, mortwtsa, psu, strata))), ~ifelse(. %in% c(91, 96, 97, 98, 99, 970, 980, 990, 7777, 8888, 9999), NA, .)) %>%
  mutate(classwk2=ifelse(classwk2 %in% (7:9), NA, classwk2), #these are real values in some other variables so we'll reset them here
         racesr=ifelse(racesr==900, NA, racesr)) %>%
  mutate(dead=ifelse(mortstat==1, 1, 0),
         mortdodq=ifelse(mortdodq==1, 91.25, #assume deaths occurred at the end of the quarter
                         ifelse(mortdodq==2, 182.5,
                                ifelse(mortdodq==3, 273.75, 
                                       ifelse(mortdodq==4, 365, NA)))),
         time=ifelse(dead==0, 2016 - year, mortdody + (mortdodq/365) - year), #deaths were allowed to occur through the end of Dec 31 2015, i.e., 2016
         dead_ten=ifelse(dead==0, 0,
                         ifelse(dead==1 & time<=10, 1,
                                ifelse(dead==1 & time>10, 0, NA))),
         time_ten=ifelse(dead_ten==1, mortdody + (mortdodq/365) - year,
                         ifelse(dead_ten==0, 2016-year, NA)),
         time_ten=ifelse(time_ten>10, 10, time_ten), #cap follow-up time at 10 years
         #i think this code for cause-specific mortality may be incorrect - need to treat deaths from other causes as censoring event rather than allowing them accumulate f/u time (or need to estimate Fine-Gray models)
         dead_od_su=ifelse(year>=2005, NA, #suicide and OD deaths
                           ifelse(mortstat==1 & (mortucod==122 | mortucod==125 | mortucod==126), 1, 0)),
         time_od_su=ifelse(dead_od_su==0, 2007 - year, mortdody + (mortdodq/365) - year), #deaths were allowed to occur through the end of Dec 31 2006, i.e., 2007
         dead_other=ifelse(year>=2005, NA, #deaths from other causes
                           ifelse(mortstat==1 & dead_od_su!=1, 1, 0)),
         manager=ifelse(occ1995>=102 & occ1995<=104, 1, 0),
         class=factor(ifelse(empstat==220, "NILF",
                             ifelse((empstat>=210 & empstat<=214) | (year<2001 & (classwk>=20 & classwk<=34) & manager!=1) | (year>=2001 & (classwk2>=1 & classwk2<=4) & manager!=1), "Worker",
                                    ifelse((year<2001 & (classwk>=20 & classwk<=34) & manager==1) | (year>=2001 & (classwk2>=1 & classwk2<=4) & manager==1), "Manager",
                                           ifelse((year<2001 & classwk==41) | (year>=2001 & classwk2==5 & jobsecincorp==2), "Capitalist",
                                                  ifelse((year<2001 & (classwk==42 | classwk==50)) | ((year>=2001 & classwk2==6) | (year>=2001 & classwk2==5 & jobsecincorp==1)), "PB", NA))))), 
                      levels=c("Worker", "Manager", "PB", "Capitalist", "NILF")),
         race=ifelse(racesr==100, "White", 
                     ifelse(racesr==200, "Black", "Other")),
         race_h=factor(ifelse(hispeth!=10, "Hispanic",
                              ifelse(hispeth==10 & race=="White", "NH white",
                                     ifelse(hispeth==10 & race=="Black", "NH black", "NH other"))), levels=c("NH white", "NH black", "Hispanic", "NH other")),
         poc=ifelse(race_h=="NH white", "NH white", "POC"),
         sex=ifelse(sex==1, "male", "female"),
         educ=factor(ifelse(educrec1<13, "<HS",
                            ifelse(educrec1==13, "HS",
                                   ifelse(educrec1==14, "Some college", "College+"))), levels=c("<HS", "HS", "Some college", "College+")),
         marital_tri=factor(ifelse(marstat %in% 10:12, "Married",
                                   ifelse(marstat %in% 20:40, "Widowed/divorced/separated", "Single")), levels=c("Married", "Single", "Widowed/divorced/separated")),
         region=ifelse(region==1, "NE", 
                       ifelse(region==2, "MW",
                              ifelse(region==3, "S", "W"))),
         class_gender=factor(ifelse(class=="Worker" & sex=="male", "Male worker",
                                    ifelse(class=="Worker" & sex=="female", "Female worker",
                                           ifelse(class=="Manager" & sex=="male", "Male manager",
                                                  ifelse(class=="Manager" & sex=="female", "Female manager",
                                                         ifelse(class=="PB" & sex=="male", "Male PB",
                                                                ifelse(class=="PB" & sex=="female", "Female PB",
                                                                       ifelse(class=="Capitalist" & sex=="male", "Male capitalist",
                                                                              ifelse(class=="Capitalist" & sex=="female", "Female capitalist",
                                                                                     ifelse(class=="NILF" & sex=="male", "Male NILF",
                                                                                            ifelse(class=="NILF" & sex=="female", "Female NILF", NA)))))))))),
                             levels=c("Male worker", "Male manager", "Male PB", "Male capitalist", "Male NILF",
                                      "Female worker", "Female manager", "Female PB", "Female capitalist", "Female NILF")),
         class_poc=factor(ifelse(class=="Worker" & poc=="NH white", "NH white worker",
                                 ifelse(class=="Worker" & poc=="POC", "POC worker",
                                        ifelse(class=="Manager" & poc=="NH white", "NH white manager",
                                               ifelse(class=="Manager" & poc=="POC", "POC manager",
                                                      ifelse(class=="PB" & poc=="NH white", "NH white PB",
                                                             ifelse(class=="PB" & poc=="POC", "POC PB",
                                                                    ifelse(class=="Capitalist" & poc=="NH white", "NH white capitalist",
                                                                           ifelse(class=="Capitalist" & poc=="POC", "POC capitalist", 
                                                                                  ifelse(class=="NILF" & poc=="NH white", "NH white NILF", 
                                                                                         ifelse(class=="NILF" & poc=="POC", "POC NILF", NA)))))))))),
                          levels=c("NH white worker", "NH white manager", "NH white PB", "NH white capitalist", "NH white NILF",
                                   "POC worker", "POC manager", "POC PB", "POC capitalist", "POC NILF")),
         class_region=factor(ifelse(class=="Worker" & region=="MW", "MW worker",
                                    ifelse(class=="Worker" & region=="NE", "NE worker",
                                           ifelse(class=="Worker" & region=="S", "S worker",
                                                  ifelse(class=="Worker" & region=="W", "W worker",
                                                         ifelse(class=="Manager" & region=="MW", "MW manager",
                                                                ifelse(class=="Manager" & region=="NE", "NE manager",
                                                                       ifelse(class=="Manager" & region=="S", "S manager",
                                                                              ifelse(class=="Manager" & region=="W", "W manager",
                                                                                     ifelse(class=="PB" & region=="MW", "MW PB",
                                                                                            ifelse(class=="PB" & region=="NE", "NE PB",
                                                                                                   ifelse(class=="PB" & region=="S", "S PB",
                                                                                                          ifelse(class=="PB" & region=="W", "W PB",
                                                                                                                 ifelse(class=="Capitalist" & region=="MW", "MW capitalist",
                                                                                                                        ifelse(class=="Capitalist" & region=="NE", "NE capitalist",
                                                                                                                               ifelse(class=="Capitalist" & region=="S", "S capitalist",
                                                                                                                                      ifelse(class=="Capitalist" & region=="W", "W capitalist", 
                                                                                                                                             ifelse(class=="NILF" & region=="MW", "MW NILF",
                                                                                                                                                    ifelse(class=="NILF" & region=="NE", "NE NILF",
                                                                                                                                                           ifelse(class=="NILF" & region=="S", "S NILF",
                                                                                                                                                                  ifelse(class=="NILF" & region=="W", "W NILF", NA)))))))))))))))))))),
                             levels=c("MW worker", "NE worker", "S worker", "W worker", "MW manager", "NE manager", "S manager", "W manager",
                                      "MW PB", "NE PB", "S PB", "W PB", "MW capitalist", "NE capitalist", "S capitalist", "W capitalist",
                                      "MW NILF", "NE NILF", "S NILF", "W NILF"))) -> dat
                                                                                     
#exclude one respondent with negative follow-up time
dat %>%
  filter(time>=0) -> dat
```

```{r }
#center data for the single-PSU stratum at the sample grand mean rather than the stratum mean (conservative)
options(survey.lonely.psu="adjust")

#make imputed survey design object
svy_dat <- svydesign(ids = ~ psu,
                     strata = ~ strata, 
                     weights = ~ mortwt,
                     nest=TRUE, 
                     data=dat)
```

# Descriptives

```{r message=FALSE, warning=FALSE}
#vars of interest
vars <- c('sex', 'race_h', 'educ', 'marital_tri', 'region', 'age')
catvars <- c("sex")
nonorm <- c('age')
x <- svyCreateTableOne(data = subset(svy_dat, age>=25 & age<65 & !is.na(class) & !is.na(sex) & !is.na(race_h) & !is.na(educ) & !is.na(marital_tri) & !is.na(region) & !is.na(age)), 
                       vars=vars, factorVars=catvars, strata='class')
x <- print(x, printToggle=FALSE, noSpaces=TRUE, nonnormal=nonorm, format='p')
kable(x[,1:5]) %>%
  kable_styling(c("striped", "condensed"))
```

# Class and mortality

## All-cause 

### Overall

#### Minimally adjusted (age, gender, year)

```{r warning=FALSE, message=FALSE}
#######full follow-up
#survival overall
mod <- svycoxph(Surv(time, dead) ~ class + rcs(age, 3) + sex + rcs(year, 5), design=subset(svy_dat, age>=25 & age<65))
kable(tidy(mod, exponentiate = T, conf.int = T)[1:4,c(1,2,7,8)], digits=2, caption="Ref: worker") %>%
  kable_styling("striped")
```

#### More adjusted (age, gender, year, racialized group, education, marital status, and region)

```{r warning=FALSE, message=FALSE}
#######full follow-up
#survival overall
mod <- svycoxph(Surv(time, dead) ~ class + rcs(age, 3) + sex + rcs(year, 5) + race_h + educ + marital_tri + region, design=subset(svy_dat, age>=25 & age<65))
kable(tidy(mod, exponentiate = T, conf.int = T)[1:4,c(1,2,7,8)], digits=2, caption="Ref: worker") %>%
  kable_styling("striped")
```

#### Year interaction centered in 1986

```{r warning=FALSE, message=FALSE}
#######full follow-up
#survival overall
mod <- svycoxph(Surv(time, dead) ~ class*I(year-1986) + rcs(age, 3) + sex, design=subset(svy_dat, age>=25 & age<65))
kable(tidy(mod, exponentiate = T, conf.int = T)[1:4,c(1,2,7,8)], digits=2, caption="Ref: worker in 1986") %>%
  kable_styling("striped")
```

#### Year interaction centered in 2014 

```{r warning=FALSE, message=FALSE}
#######full follow-up
#survival overall
mod <- svycoxph(Surv(time, dead) ~ class*I(year-2014) + rcs(age, 3) + sex, design=subset(svy_dat, age>=25 & age<65))
kable(tidy(mod, exponentiate = T, conf.int = T)[1:4,c(1,2,7,8)], digits=2, caption="Ref: worker in 2014") %>%
  kable_styling("striped")
```

### By racialized group

```{r warning=FALSE, message=FALSE}
#######full follow-up
#survival overall
mod <- svycoxph(Surv(time, dead) ~ class_poc + rcs(age, 3) + sex + rcs(year, 5), design=subset(svy_dat, age>=25 & age<65))
kable(tidy(mod, exponentiate = T, conf.int = T)[1:9,c(1,2,7,8)], digits=2, caption="Ref: NH white worker") %>%
  kable_styling("striped")
```

### By gender

```{r warning=FALSE, message=FALSE}
#######full follow-up
#survival overall
mod <- svycoxph(Surv(time, dead) ~ class_gender + rcs(age, 3) + rcs(year, 5), design=subset(svy_dat, age>=25 & age<65))
kable(tidy(mod, exponentiate = T, conf.int = T)[1:9,c(1,2,7,8)], digits=2, caption="Ref: Male worker") %>%
  kable_styling("striped")
```

### By region

```{r warning=FALSE, message=FALSE}
#######full follow-up
#survival overall
mod <- svycoxph(Surv(time, dead) ~ class_region + rcs(age, 3) + sex + rcs(year, 5), design=subset(svy_dat, age>=25 & age<65))
kable(tidy(mod, exponentiate = T, conf.int = T)[1:19,c(1,2,7,8)], digits=2, caption="Ref: MW worker") %>%
  kable_styling("striped")
```
